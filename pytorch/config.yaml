wandb:
  project: "202602_hpt"
  name: "${feature.audio_feature}-${adapter.type}-${model.name}-${score_informed.method}-${loss.loss_type}-k${loss.kim_loss_alpha}-l1${loss.w_l1}-b${loss.w_bce}-d${loss.w_delta}-uh${loss.use_huber}-wh${loss.w_huber}-hd${loss.huber_delta}-ext${model.input2}${model.input3}-sr${feature.sample_rate}" # -iter${exp.total_iteration}
  comment: "mel128"
  log_velocity_interval: ${exp.eval_iteration}  # Set 0/null to disable WandB velocity roll images


exp:
  # workspace: "./workspaces" #kaya
  # workspace: "/media/datadisk/home/22828187/zhanh/202510_hpt_data/workspaces" #uwa
  # workspace: "/Users/hanyu/Documents/ipynb/202510_hpt_data/workspaces" #mac
  workspace: "/media/mengh/SharedData/zhanh/202510_hpt_data/workspaces" #mengh
  resume_iteration: 0
  total_iteration: 120_000 # 200_000 # 300_000 # 360_000
  save_iteration: 10_000    # 6_000 # 6_000
  eval_iteration: 10_000    # 6_000 # 6_000

  learning_rate: 1e-4 # 3e-4 # 1e-4
  optim: "adam" # "adam", "ranger", Ranger: default betas=(0.9, 0.999), eps=1e-08, weight_decay=0.
  decay: True # False
  reduce_iteration: 10_000 # 6_000
  random_seed: 86

  mini_data: False # True when developing model
  cuda: True
  debug: False
  num_workers: 12 # 6 for Score Calculating
  batch_size: 12

  # Infer and Eval
  run_infer: 'single' # 'multi'
  ckpt_iteration: ""  # 180_000
  ckpt_file: ""


feature:
  audio_feature: "logmel"
  classes_num: 88
  # ---------------------------
  # dataloader.py params
  segment_seconds: 10.
  hop_seconds: 1.
  # ---------------------------
  # feature_extractor.py params
  # mel_bins: 229 # 去feature extractor里面手动定义吧
  sample_rate: 22050
  fft_size: 2048
  frames_per_second: 100
  augmentor: null
  # ---------------------------
  begin_note: 21
  velocity_scale: 128
  max_note_shift: 0


dataset:
  # Fix "maestro" for (train valid), select "smd|maestro|map" for (test)
  train_set: "maestro"
  test_set: "smd"

  # Use the same workspace root as features.py packs to
  train_h5: "${exp.workspace}/hdf5s/${dataset.train_set}"
  test_h5: "${exp.workspace}/hdf5s/${dataset.test_set}"

  # Provide dataset dir to process the features.py
  smd_dir: "../Dataset/SMD"
  maestro_dir: "../Dataset/maestro-v3.0.0"
  maps_dir: "../Dataset/MAPS"


model:
  type: "velo" # "notes"
  # -------------------------------------------------------------------------
  # name options:
  #   Single_Velocity_HPT
  #   DynestAudioCNN
  #   HPPNet_SP
  # -------------------------------------------------------------------------
  name: "Single_Velocity_HPT"
  # score-inf condition selector:
  # null+null => method defaults (typically onset+frame+exframe in method code).
  # if either input is set, it overrides method cond selection.
  # for scrr/dual_gated/bilstm, onset is auto-included when missing.
  input2: null # frame | exframe | onset | null
  input3: null # frame | exframe | onset | null
  kim_condition: "frame" # for FiLMUNetPretrained only: frame | none
  pretrained_checkpoint: "/media/datadisk/home/22828187/zhanh/202510_hpt_data/workspaces/checkpoints/FiLMUNetPretrained+frame/1000000_iterations.pth"
  hppnet_model_size: 128


post:
  post_processor_type: 'regression' # 'onsets_frames'
  # regression (0.1, 0.3, 0.3), onsets_frames (0.5, 0.1, 0.3)
  frame_threshold: 0.3 # 0.1 in RegressionPostProcessor, 0.3 in score_calculator
  onset_threshold: 0.3
  offset_threshold: 0.3
  pedal_offset_threshold: 0.2


score:
  evaluate_frame: True
  evaluate_velocity: True
  evaluate_pedal: False # No implemented yet
  
  onset_tolerance: 0.05 # 1
  offset_ratio: 0.2 # null | 0.2
  offset_min_tolerance: # 0.05 # 1

# ---------------------------
# Loss configuration
# ---------------------------
loss:
  loss_type: "velocity_bce"
  kim_loss_alpha: 0.5  # Weight of BCE term in Kim et al. 2024 BCE+L1 loss
  w_l1: 1.0
  w_bce: 0.5
  w_delta: 0.01  # set 0 to disable delta regularization
  use_huber: true
  w_huber: 1.0
  huber_delta: 0.1

# ---------------------------
# Score-informed training (train_score_inf.py)
# ---------------------------
adapter:
  type: "hpt"   # hpt | hppnet | dynest
  params: {}

score_informed:
  method: "direct_output"     # direct_output | scrr | dual_gated | note_editor | bilstm
  params: {}
  freeze_base: false
  base_checkpoint: ""    # path to pretrained base model
  base_iteration: ""     # optional iteration id under workspace/checkpoints
